# è¶…æœ€å°é™ TODO ã‚¢ãƒ—ãƒª - PowerShell+JavaScript ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 
# è¨­è¨ˆåŸå‰‡: æœ€å°é™ã‚¹ã‚¿ãƒ¼ãƒˆ â†’ æˆé•·ã—ãªãŒã‚‰å­¦ç¿’

# C#ã¯æœ€å°é™ï¼šLLMå‡¦ç†ã®ã¿
Add-Type @"
using System.Collections.Generic;
public class LLM {
    public static (string content, bool needsTool, List<string> items) Parse(string msg) {
        var items = new List<string>();
        var needsTool = false;
        var content = "";
        
        if (msg.Contains("é€±æœ«") || msg.Contains("äºˆå®š")) {
            content = "é€±æœ«ã®äºˆå®šã‚’æ•´ç†ã—ã¾ã—ã‚‡ã†ï¼ã‚„ã‚ŠãŸã„ã“ã¨ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚";
        }
        else if (msg.Contains("æ´—æ¿¯") || msg.Contains("è²·ã„ç‰©") || msg.Contains("æ˜ ç”»") || msg.Contains("èª­æ›¸")) {
            if (msg.Contains("æ˜ ç”»")) items.Add("å‹é”ã¨æ˜ ç”»ã‚’è¦‹ã‚‹");
            if (msg.Contains("æ´—æ¿¯")) items.Add("æ´—æ¿¯ã‚’ã™ã‚‹");
            if (msg.Contains("è²·ã„ç‰©")) items.Add("è²·ã„ç‰©ã«è¡Œã");
            if (msg.Contains("èª­æ›¸")) items.Add("èª­æ›¸ã‚’ã™ã‚‹");
            
            content = "ä»¥ä¸‹ã®ã‚¿ã‚¹ã‚¯ã‚’æ•´ç†ã—ã¾ã—ãŸï¼š\n";
            foreach (var item in items) content += "â€¢ " + item + "\n";
            content += "\nå„ªå…ˆé †ä½ã‚’ä»˜ã‘ã¦ä¿å­˜ã—ã¾ã™ã­ã€‚";
            needsTool = true;
        }
        else {
            content = "ã©ã®ã‚ˆã†ãªã“ã¨ã‚’æ•´ç†ã—ãŸã„ã§ã™ã‹ï¼Ÿ";
        }
        
        return (content, needsTool, items);
    }
}
"@

# HTTPã‚µãƒ¼ãƒãƒ¼é–‹å§‹
$ls = [System.Net.HttpListener]::new()
$ls.Prefixes.Add("http://*:3000/")
$ls.Start()

Write-Host "âš¡ TODO ã‚µãƒ¼ãƒãƒ¼èµ·å‹• http://localhost:3000/" -ForegroundColor Green
Write-Host "ğŸ“ PowerShellãŒLLMå‡¦ç†ã€JavaScriptãŒGUIæ‹…å½“" -ForegroundColor Cyan
Write-Host "ğŸ¯ æœ€å°é™ã‚¹ã‚¿ãƒ¼ãƒˆ â†’ æˆé•·å‹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ " -ForegroundColor Yellow

while ($ls.IsListening) {
    $ctx = $ls.GetContext()
    $req = $ctx.Request
    $res = $ctx.Response
    
    # CORSè¨­å®š
    $res.AddHeader("Access-Control-Allow-Origin", "*")
    $res.AddHeader("Access-Control-Allow-Methods", "GET, POST, OPTIONS")
    $res.AddHeader("Access-Control-Allow-Headers", "Content-Type")
    
    if ($req.HttpMethod -eq "OPTIONS") {
        $res.StatusCode = 200
        $res.Close()
        continue
    }
    
    $path = $req.Url.LocalPath
    Write-Host "ğŸ“ $($req.HttpMethod) $path" -ForegroundColor Gray
    
    try {
        if ($path -eq "/todo-app.html") {
            # HTMLãƒ•ã‚¡ã‚¤ãƒ«é…ä¿¡
            if (Test-Path "todo-app.html") {
                $html = Get-Content "todo-app.html" -Raw -Encoding UTF8
                $buf = [System.Text.Encoding]::UTF8.GetBytes($html)
                $res.ContentType = "text/html; charset=utf-8"
                $res.ContentLength64 = $buf.Length
                $res.OutputStream.Write($buf, 0, $buf.Length)
            } else {
                $res.StatusCode = 404
            }
        }
        elseif ($path -eq "/api/chat" -and $req.HttpMethod -eq "POST") {
            # LLMå‡¦ç† (PowerShellè²¬ä»»ç¯„å›²)
            $reader = [System.IO.StreamReader]::new($req.InputStream, $req.ContentEncoding)
            $body = $reader.ReadToEnd() | ConvertFrom-Json
            $reader.Close()
            
            $msg = $body.messages[-1].content
            $result = [LLM]::Parse($msg)
            
            $response = @{
                type = "message"
                role = "assistant"
                content = @(@{ type = "text"; text = $result.content })
            }
            
            if ($result.needsTool) {
                $toolArgs = @{ 
                    items = @($result.items)
                    category = "weekend"
                    priority = "medium"
                    timestamp = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ss")
                    id = [DateTimeOffset]::Now.ToUnixTimeMilliseconds()
                }
                $response.tool_calls = @(@{
                    type = "function"
                    function = @{
                        name = "todo_save"
                        arguments = ($toolArgs | ConvertTo-Json -Compress)
                    }
                })
            }
            
            $json = ConvertTo-Json $response -Depth 10
            $buf = [System.Text.Encoding]::UTF8.GetBytes($json)
            $res.ContentType = "application/json; charset=utf-8"
            $res.ContentLength64 = $buf.Length
            $res.OutputStream.Write($buf, 0, $buf.Length)
            
            Write-Host "ğŸ’¬ LLMå‡¦ç†å®Œäº†: $($msg.Substring(0, [Math]::Min(30, $msg.Length)))..." -ForegroundColor Yellow
        }
        else {
            $res.StatusCode = 404
            $error = @{ error = "Not found: $path" } | ConvertTo-Json
            $buf = [System.Text.Encoding]::UTF8.GetBytes($error)
            $res.ContentType = "application/json; charset=utf-8"
            $res.ContentLength64 = $buf.Length
            $res.OutputStream.Write($buf, 0, $buf.Length)
        }
    } catch {
        Write-Host "âš ï¸ Error: $($_.Exception.Message)" -ForegroundColor Red
        $res.StatusCode = 500
    } finally {
        $res.Close()
    }
}
