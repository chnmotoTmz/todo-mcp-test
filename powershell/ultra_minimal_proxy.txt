# ğŸŒ± æœ€å°é™ã‚¹ã‚¿ãƒ¼ãƒˆå‹ TODOç®¡ç† - PowerShell+JavaScriptæ•™æ
# ç¾å­¦: é–¢æ•°åˆ†å‰² + çŸ­ç¸®å‘½å + ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°

function INIT-TODO {
    Add-Type -AssemblyName System.Net

    # C#ã¯æœ€å°é™ï¼šLLMå‡¦ç†ã®ã¿
    Add-Type @"
using System;
using System.Collections.Generic;

public class LLM 
{
    public static LLMResult Parse(string message) 
    {
        var items = new List<string>();
        var needsTool = false;
        var content = "";
        
        if (message.Contains("é€±æœ«") || message.Contains("äºˆå®š")) 
        {
            content = "é€±æœ«ã®äºˆå®šã‚’æ•´ç†ã—ã¾ã—ã‚‡ã†ï¼ã‚„ã‚ŠãŸã„ã“ã¨ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚";
        }
        else if (message.Contains("æ´—æ¿¯") || message.Contains("è²·ã„ç‰©") || message.Contains("æ˜ ç”»") || message.Contains("èª­æ›¸")) 
        {
            if (message.Contains("æ˜ ç”»")) items.Add("å‹é”ã¨æ˜ ç”»ã‚’è¦‹ã‚‹");
            if (message.Contains("æ´—æ¿¯")) items.Add("æ´—æ¿¯ã‚’ã™ã‚‹");
            if (message.Contains("è²·ã„ç‰©")) items.Add("è²·ã„ç‰©ã«è¡Œã");
            if (message.Contains("èª­æ›¸")) items.Add("èª­æ›¸ã‚’ã™ã‚‹");
            
            content = "ä»¥ä¸‹ã®ã‚¿ã‚¹ã‚¯ã‚’æ•´ç†ã—ã¾ã—ãŸï¼š\n";
            foreach (var item in items)
            {
                content += "â€¢ " + item + "\n";
            }
            content += "\nå„ªå…ˆé †ä½ã‚’ä»˜ã‘ã¦ä¿å­˜ã—ã¾ã™ã­ã€‚";
            needsTool = true;
        }
        else 
        {
            content = "ã©ã®ã‚ˆã†ãªã“ã¨ã‚’æ•´ç†ã—ãŸã„ã§ã™ã‹ï¼Ÿ";
        }
        
        return new LLMResult { Content = content, NeedsTool = needsTool, Items = items };
    }
}

public class LLMResult
{
    public string Content { get; set; }
    public bool NeedsTool { get; set; }
    public List<string> Items { get; set; }
    
    public LLMResult()
    {
        Items = new List<string>();
    }
}
"@
    
    $global:ls = [System.Net.HttpListener]::new()
    $ls.Prefixes.Add("http://*:3000/")
    $ls.Start()
    
    Write-Host "âš¡ TODO ã‚µãƒ¼ãƒãƒ¼èµ·å‹•å®Œäº† http://*:3000/" -ForegroundColor Green
    Write-Host "ğŸ“ http://localhost:3000/todo-app.html ã§ã‚¢ã‚¯ã‚»ã‚¹" -ForegroundColor Cyan
    Write-Host "ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã¯JavaScriptå´ã§ç®¡ç†" -ForegroundColor Yellow
    Write-Host "ğŸ›‘ Ctrl+C ã§çµ‚äº†" -ForegroundColor Red
}

function SET-CORS($rs) {
    $rs.AddHeader("Access-Control-Allow-Origin", "*")
    $rs.AddHeader("Access-Control-Allow-Methods", "GET, POST, OPTIONS")
    $rs.AddHeader("Access-Control-Allow-Headers", "Content-Type")
    $rs.ContentType = "application/json; charset=utf-8"
}

function SEND-JSON($rs, $obj) {
    $json = ConvertTo-Json $obj -Depth 10
    $buf = [System.Text.Encoding]::UTF8.GetBytes($json)
    $rs.ContentLength64 = $buf.Length
    $rs.OutputStream.Write($buf, 0, $buf.Length)
    $rs.OutputStream.Flush()
}

function SEND-HTML($rs, $file) {
    if (Test-Path $file) {
        $html = Get-Content $file -Raw -Encoding UTF8
        $buf = [System.Text.Encoding]::UTF8.GetBytes($html)
        $rs.ContentType = "text/html; charset=utf-8"
        $rs.ContentLength64 = $buf.Length
        $rs.OutputStream.Write($buf, 0, $buf.Length)
        $rs.OutputStream.Flush()
        $rs.StatusCode = 200
    } else {
        $rs.StatusCode = 404
        SEND-JSON $rs @{ error = "File not found: $file" }
    }
}

function HANDLE-CHAT($rq, $rs) {
    $reader = [System.IO.StreamReader]::new($rq.InputStream, $rq.ContentEncoding)
    $body = $reader.ReadToEnd() | ConvertFrom-Json
    $reader.Close()
    
    $msg = $body.messages[-1].content
    $result = [LLM]::Parse($msg)
    
    $response = @{
        type = "message"
        role = "assistant"
        content = @(@{ type = "text"; text = $result.Content })
    }
    
    if ($result.NeedsTool) {
        $toolArgs = @{ 
            items = @($result.Items)
            category = "weekend"
            priority = "medium"
            timestamp = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ss")
            id = [DateTimeOffset]::Now.ToUnixTimeMilliseconds()
        }
        $response.tool_calls = @(@{
            type = "function"
            function = @{
                name = "todo_save"
                arguments = ($toolArgs | ConvertTo-Json -Compress)
            }
        })
    }
    
    SEND-JSON $rs $response
    Write-Host "ğŸ’¬ LLMå‡¦ç†: $($msg.Substring(0, [Math]::Min(30, $msg.Length)))..." -ForegroundColor Yellow
}

function HANDLE-REQUEST($ct) {
    $rq = $ct.Request
    $rs = $ct.Response
    
    SET-CORS $rs
    
    if ($rq.HttpMethod -eq "OPTIONS") {
        $rs.StatusCode = 200
        $rs.ContentLength64 = 0
        $rs.Close()
        return
    }
    
    $path = $rq.Url.LocalPath
    Write-Host "ğŸ“ $($rq.HttpMethod) $path" -ForegroundColor Gray
    
    try {
        switch ($path) {
            "/todo-app.html" { SEND-HTML $rs "todo-app.html" }
            "/api/chat" { 
                if ($rq.HttpMethod -eq "POST") { 
                    HANDLE-CHAT $rq $rs 
                } else {
                    $rs.StatusCode = 405
                    SEND-JSON $rs @{ error = "Method not allowed" }
                }
            }
            default { 
                $rs.StatusCode = 404
                SEND-JSON $rs @{ error = "Endpoint not found: $path" }
                Write-Host "âŒ 404: $path" -ForegroundColor Red
            }
        }
    } catch {
        $rs.StatusCode = 500
        SEND-JSON $rs @{ error = "Server error: $($_.Exception.Message)" }
        Write-Host "âš ï¸ Error: $($_.Exception.Message)" -ForegroundColor Red
    } finally {
        $rs.Close()
    }
}

function RUN-SERVER {
    while ($global:ls.IsListening) {
        try {
            $ct = $global:ls.GetContext()
            HANDLE-REQUEST $ct
        } catch {
            Write-Host "ğŸš¨ Server error: $($_.Exception.Message)" -ForegroundColor Red
        }
    }
}

try {
    INIT-TODO
    RUN-SERVER
} catch {
    Write-Host "âŒ èµ·å‹•ã‚¨ãƒ©ãƒ¼: $($_.Exception.Message)" -ForegroundColor Red
} finally {
    if ($global:ls -and $global:ls.IsListening) {
        $global:ls.Stop()
        Write-Host "ğŸ›‘ ã‚µãƒ¼ãƒãƒ¼åœæ­¢" -ForegroundColor Yellow
    }
}